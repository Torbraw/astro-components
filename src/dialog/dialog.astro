---
import { twMerge } from 'tailwind-merge';
import type { HTMLAttributes } from 'astro/types';

type Props = HTMLAttributes<'dialog'> & {
  dialogId: string;
};
const { class: className = '', dialogId } = Astro.props;
---

<astro-dialog data-dialog-id={dialogId}>
  <dialog
    id={dialogId}
    data-closing="false"
    class={twMerge(
      'bg-background text-primary border shadow-lg sm:rounded-lg backdrop:bg-background/80 w-full max-w-lg backdrop:backdrop-blur-sm open:backdrop:animate-in open:backdrop:fade-out-0 m-0 left-[50%] top-[50%] translate-x-[-50%] translate-y-[-50%] duration-200 open:animate-in data-[closing=true]:animate-out data-[closing=true]:fade-out-0 open:fade-in-0 data-[closing=true]:zoom-out-95 open:zoom-in-95 data-[closing=true]:slide-out-to-left-1/2 data-[closing=true]:slide-out-to-top-[48%] open:slide-in-from-left-1/2 open:slide-in-from-top-[48%]',
      className,
    )}
    {...Astro.props}
  >
    <slot />
  </dialog>
</astro-dialog>

<script>
  class AstroDialog extends HTMLElement {
    constructor() {
      super();
      const dialogId = this.dataset.dialogId as string;
      const dialog = document.getElementById(dialogId) as HTMLDialogElement;
      const btn = dialog.querySelector(`#close-btn-${dialogId}`) as HTMLButtonElement;

      dialog.addEventListener('webkitAnimationEnd', () => {
        if (dialog.dataset.closing === 'true') {
          dialog.dataset.closing = 'false';
          dialog.close();
        }
      });

      btn.addEventListener('click', () => {
        dialog.dataset.closing = 'true';
      });

      dialog.addEventListener('click', (event) => {
        if (event.target === dialog) {
          dialog.dataset.closing = 'true';
        }
      });

      dialog.addEventListener('cancel', (event) => {
        event.preventDefault();
        dialog.dataset.closing = 'true';
      });
    }
  }

  customElements.define('astro-dialog', AstroDialog);
</script>
